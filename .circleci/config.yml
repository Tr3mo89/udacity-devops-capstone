version: 2.1

orbs:
  docker: circleci/docker@2.0.1

commands:
  install-dependencies:
    description: install dependencies
    steps:
      - run:
          name: install dependencies
          command: |
            pip install --upgrade pip && pip install -r requirements.txt
            pip install cython
            pip install pandas
  install-docker:
    description: install docker
    steps:
      - run:
          name: install docker
          command: |
            DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y \
              ca-certificates \
              curl \
              gnupg \
              lsb-release
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
            echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
            apt-get update
            apt-get install -y docker-ce docker-ce-cli containerd.io
            docker --version
  start-docker-daemon:
    description: start docker deamon
    steps:
      - run:
          name: start docker daemon
          command: |
            systemctl daemon-reload
            ExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock
            systemctl restart docker
            systemctl status docker
            docker --version


jobs:
  linting:
    docker:
      - image: python:3.7.3-stretch
    steps:
      - checkout
      - install-dependencies
      - run:
          name: install lint
          command: |
            wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v1.16.3/hadolint-Linux-x86_64
            chmod +x /bin/hadolint
            hadolint --version
      - run: 
          name: lint the dockerfile
          command: |
            pwd
            ls -la
            make lint
  
  handle_docker_image:
    docker:
      - image: tr3mo89/ubuntu-20.04-docker
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.7
      - run:
          name: set dockerpath
          command: |
            export dockerpath="tr3mo89/udacity-capstone"
      - run: 
          name: build image
          command: |
            docker build -t $dockerpath:latest .
      - run: 
          name: tag image
          command: |
            docker tag $dockerpath:latest $dockerpath:latest
      - run:
          name: push image
          command: |
            docker push $dockerpath:latest

workflows:
  application-pipeline:
    jobs:
      - linting
      - handle_docker_image