version: 2.1

commands:
  install-dependencies:
    description: install dependencies
    steps:
      - run:
          name: install dependencies
          command: |
            pip install --upgrade pip && pip install -r requirements.txt
            pip install cython
            pip install pandas
  install-docker:
    description: install docker
    steps:
      - run:
          name: install docker
          command: |
            DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y \
              ca-certificates \
              curl \
              gnupg \
              lsb-release
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
            echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
            apt-get update
            apt-get install -y docker-ce docker-ce-cli containerd.io
            docker --version

jobs:
  linting:
    docker:
      - image: python:3.7.3-stretch
    steps:
      - checkout
      - install-dependencies
      - run:
          name: install lint
          command: |
            wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v1.16.3/hadolint-Linux-x86_64
            chmod +x /bin/hadolint
            hadolint --version
      - run: 
          name: lint the dockerfile
          command: |
            pwd
            ls -la
            make lint
  
  build_image:
    docker:
      - image: tr3mo89/ubuntu-20.04-docker:latest
    steps:
      - checkout
      - install-docker
      - run: 
          name: build image
          command: |
            ls -la
            docker build -t udacity/flask:latest .
  
  
  push_image:
    docker:
      - image: tr3mo89/ubuntu-20.04-docker:latest
    steps:
      - checkout
      - install-docker
      - run:
          name: set dockerpath
          command: |
            dockerpath="tr3mo89/udacity-capstone"
      - run: 
          name: tag_image
          command: |
            docker tag udacity/flask:latest $dockerpath:latest
      - run:
          name: push image
          command: |
            docker push $dockerpath


workflows:
  application-pipeline:
    jobs:
      - linting
      - build_image #:
          #requires: [linting]  #### increase deployment speed
      - push_image:
          requires: [build_image]